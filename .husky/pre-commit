# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${GREEN}üîç Running pre-commit checks...${NC}"

# 1. Lint staged files (formatting + eslint)
echo "\n${YELLOW}üìù Linting staged files...${NC}"
npx lint-staged
if [ $? -ne 0 ]; then
  echo "${RED}‚ùå Linting failed. Fix errors and try again.${NC}"
  exit 1
fi

# 2. Type checking
echo "\n${YELLOW}üîé Type checking...${NC}"
npm run typecheck
if [ $? -ne 0 ]; then
  echo "${RED}‚ùå Type check failed. Fix TypeScript errors and try again.${NC}"
  exit 1
fi

# 3. Validar schema Prisma se foi modificado
if git diff --cached --name-only | grep -q "prisma/schema.prisma"; then
  echo "\n${YELLOW}üóÑÔ∏è  Validating Prisma schema...${NC}"
  npx prisma validate
  if [ $? -ne 0 ]; then
    echo "${RED}‚ùå Prisma schema validation failed.${NC}"
    exit 1
  fi
  echo "${GREEN}‚ö†Ô∏è  Prisma schema changed. Don't forget to run 'npm run db:push'${NC}"
fi

# 4. Verificar se h√° secrets expostos (opcional - comentado por padr√£o)
# echo "\n${YELLOW}üîê Checking for exposed secrets...${NC}"
# if git diff --cached | grep -E "(API_KEY|SECRET|PASSWORD|TOKEN)" | grep -v "your-" | grep -v "example"; then
#   echo "${RED}‚ùå Possible secret detected in commit. Remove sensitive data.${NC}"
#   exit 1
# fi

# 5. Prevenir commits diretos em main (opcional - comentado por padr√£o)
# BRANCH=$(git rev-parse --abbrev-ref HEAD)
# if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
#   echo "${RED}‚ùå Direct commits to main/master are not allowed. Create a branch.${NC}"
#   exit 1
# fi

echo "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}\n"
